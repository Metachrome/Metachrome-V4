<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>METACHROME Balance Fixes Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: white;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
        }
        .error {
            border-left-color: #f44336;
        }
        .warning {
            border-left-color: #ff9800;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        .balance-display {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
            margin: 10px 0;
        }
        .log {
            background: #333;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üîß METACHROME Balance Fixes Test</h1>
    <p>This page tests the two main fixes:</p>
    <ol>
        <li><strong>Balance Consistency</strong>: All pages show the same balance format</li>
        <li><strong>Withdrawal Deduction</strong>: Withdrawals actually deduct from balance</li>
    </ol>

    <div class="test-section">
        <h2>üîê Authentication</h2>
        <button onclick="loginAsUser()">Login as User (angela.soenoko)</button>
        <button onclick="loginAsAdmin()">Login as Admin</button>
        <div id="auth-status">Not logged in</div>
    </div>

    <div class="test-section">
        <h2>üí∞ Balance Consistency Test</h2>
        <p>Testing that all endpoints return the same balance format:</p>
        <button onclick="testBalanceConsistency()">Test Balance Consistency</button>
        <div id="balance-results">
            <div>Wallet Page (/api/balances): <span id="wallet-balance">-</span></div>
            <div>Options Page (/api/user/balances): <span id="options-balance">-</span></div>
            <div>Admin View (/api/admin/users): <span id="admin-balance">-</span></div>
        </div>
        <div class="log" id="balance-log"></div>
    </div>

    <div class="test-section">
        <h2>üí∏ Withdrawal Deduction Test</h2>
        <p>Testing that withdrawal approval actually deducts from balance:</p>
        <button onclick="testWithdrawalFlow()">Test Withdrawal Flow</button>
        <div id="withdrawal-results">
            <div>Initial Balance: <span id="initial-balance">-</span></div>
            <div>Withdrawal Amount: <span id="withdrawal-amount">-</span></div>
            <div>Final Balance: <span id="final-balance">-</span></div>
            <div>Balance Change: <span id="balance-change">-</span></div>
        </div>
        <div class="log" id="withdrawal-log"></div>
    </div>

    <script>
        let userToken = null;
        let adminToken = null;
        let currentUserId = null;

        function log(message, elementId = 'balance-log', isError = false) {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logElement.innerHTML += logEntry + '\n';
            logElement.scrollTop = logElement.scrollHeight;
            
            if (isError) {
                console.error(logEntry);
            } else {
                console.log(logEntry);
            }
        }

        async function loginAsUser() {
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: 'angela.soenoko',
                        password: 'password123'
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    userToken = result.token;
                    currentUserId = result.user.id;
                    document.getElementById('auth-status').innerHTML = `‚úÖ Logged in as User: ${result.user.username} (ID: ${result.user.id})`;
                    log('User login successful', 'balance-log');
                } else {
                    document.getElementById('auth-status').innerHTML = `‚ùå User login failed: ${result.error}`;
                    log(`User login failed: ${result.error}`, 'balance-log', true);
                }
            } catch (error) {
                document.getElementById('auth-status').innerHTML = `‚ùå User login error: ${error.message}`;
                log(`User login error: ${error.message}`, 'balance-log', true);
            }
        }

        async function loginAsAdmin() {
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: 'superadmin',
                        password: 'admin123'
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    adminToken = result.token;
                    document.getElementById('auth-status').innerHTML += `<br>‚úÖ Logged in as Admin: ${result.user.username}`;
                    log('Admin login successful', 'balance-log');
                } else {
                    document.getElementById('auth-status').innerHTML += `<br>‚ùå Admin login failed: ${result.error}`;
                    log(`Admin login failed: ${result.error}`, 'balance-log', true);
                }
            } catch (error) {
                document.getElementById('auth-status').innerHTML += `<br>‚ùå Admin login error: ${error.message}`;
                log(`Admin login error: ${error.message}`, 'balance-log', true);
            }
        }

        async function testBalanceConsistency() {
            if (!userToken || !adminToken) {
                log('‚ùå Please login as both user and admin first', 'balance-log', true);
                return;
            }

            log('üîÑ Testing balance consistency across all endpoints...', 'balance-log');

            try {
                // Test 1: Wallet page endpoint (/api/balances)
                const walletResponse = await fetch('/api/balances', {
                    headers: { 'Authorization': `Bearer ${userToken}` }
                });
                const walletData = await walletResponse.json();
                const walletBalance = Array.isArray(walletData) ? 
                    walletData.find(b => b.symbol === 'USDT')?.available : 
                    walletData.balance;
                document.getElementById('wallet-balance').textContent = `$${walletBalance}`;
                log(`Wallet endpoint: $${walletBalance}`, 'balance-log');

                // Test 2: Options page endpoint (/api/user/balances)
                const optionsResponse = await fetch(`/api/user/balances?userId=${currentUserId}`, {
                    headers: { 'Authorization': `Bearer ${userToken}` }
                });
                const optionsData = await optionsResponse.json();
                const optionsBalance = Array.isArray(optionsData) ? 
                    optionsData.find(b => b.symbol === 'USDT')?.available : 
                    optionsData.USDT?.available;
                document.getElementById('options-balance').textContent = `$${optionsBalance}`;
                log(`Options endpoint: $${optionsBalance}`, 'balance-log');

                // Test 3: Admin view endpoint (/api/admin/users)
                const adminResponse = await fetch('/api/admin/users', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const adminData = await adminResponse.json();
                const userInAdmin = adminData.find(u => u.id === currentUserId);
                const adminBalance = userInAdmin?.balance;
                document.getElementById('admin-balance').textContent = `$${adminBalance}`;
                log(`Admin endpoint: $${adminBalance}`, 'balance-log');

                // Check consistency
                if (walletBalance === optionsBalance && optionsBalance == adminBalance) {
                    log('‚úÖ BALANCE CONSISTENCY TEST PASSED - All endpoints show the same balance!', 'balance-log');
                } else {
                    log('‚ùå BALANCE CONSISTENCY TEST FAILED - Balances differ between endpoints', 'balance-log', true);
                    log(`Wallet: ${walletBalance}, Options: ${optionsBalance}, Admin: ${adminBalance}`, 'balance-log', true);
                }

            } catch (error) {
                log(`‚ùå Balance consistency test error: ${error.message}`, 'balance-log', true);
            }
        }

        async function testWithdrawalFlow() {
            if (!userToken || !adminToken) {
                log('‚ùå Please login as both user and admin first', 'withdrawal-log', true);
                return;
            }

            log('üîÑ Testing withdrawal deduction flow...', 'withdrawal-log');

            try {
                // Step 1: Get initial balance
                const initialResponse = await fetch('/api/balances', {
                    headers: { 'Authorization': `Bearer ${userToken}` }
                });
                const initialData = await initialResponse.json();
                const initialBalance = parseFloat(Array.isArray(initialData) ? 
                    initialData.find(b => b.symbol === 'USDT')?.available : 
                    initialData.balance);
                
                document.getElementById('initial-balance').textContent = `$${initialBalance}`;
                log(`Initial balance: $${initialBalance}`, 'withdrawal-log');

                // Step 2: Submit withdrawal request
                const withdrawalAmount = 100; // Test with $100
                document.getElementById('withdrawal-amount').textContent = `$${withdrawalAmount}`;
                
                const withdrawalResponse = await fetch('/api/withdrawals', {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${userToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: withdrawalAmount,
                        currency: 'USDT',
                        address: 'test-address-123',
                        network: 'TRC20'
                    })
                });

                if (!withdrawalResponse.ok) {
                    throw new Error('Withdrawal request failed');
                }

                log(`Withdrawal request submitted: $${withdrawalAmount}`, 'withdrawal-log');

                // Step 3: Get pending withdrawals and approve the latest one
                const pendingResponse = await fetch('/api/admin/pending-requests', {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const pendingData = await pendingResponse.json();
                const latestWithdrawal = pendingData.withdrawals?.[0];

                if (!latestWithdrawal) {
                    throw new Error('No pending withdrawal found');
                }

                log(`Found pending withdrawal: ${latestWithdrawal.id}`, 'withdrawal-log');

                // Step 4: Approve the withdrawal
                const approvalResponse = await fetch(`/api/admin/withdrawals/${latestWithdrawal.id}`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'approve'
                    })
                });

                if (!approvalResponse.ok) {
                    throw new Error('Withdrawal approval failed');
                }

                log('Withdrawal approved by admin', 'withdrawal-log');

                // Step 5: Check final balance after a short delay
                setTimeout(async () => {
                    try {
                        const finalResponse = await fetch('/api/balances', {
                            headers: { 'Authorization': `Bearer ${userToken}` }
                        });
                        const finalData = await finalResponse.json();
                        const finalBalance = parseFloat(Array.isArray(finalData) ? 
                            finalData.find(b => b.symbol === 'USDT')?.available : 
                            finalData.balance);
                        
                        document.getElementById('final-balance').textContent = `$${finalBalance}`;
                        
                        const balanceChange = finalBalance - initialBalance;
                        document.getElementById('balance-change').textContent = `$${balanceChange}`;
                        
                        log(`Final balance: $${finalBalance}`, 'withdrawal-log');
                        log(`Balance change: $${balanceChange}`, 'withdrawal-log');

                        if (Math.abs(balanceChange + withdrawalAmount) < 0.01) {
                            log('‚úÖ WITHDRAWAL DEDUCTION TEST PASSED - Balance correctly deducted!', 'withdrawal-log');
                        } else {
                            log('‚ùå WITHDRAWAL DEDUCTION TEST FAILED - Balance not properly deducted', 'withdrawal-log', true);
                            log(`Expected change: -$${withdrawalAmount}, Actual change: $${balanceChange}`, 'withdrawal-log', true);
                        }
                    } catch (error) {
                        log(`‚ùå Final balance check error: ${error.message}`, 'withdrawal-log', true);
                    }
                }, 2000); // Wait 2 seconds for processing

            } catch (error) {
                log(`‚ùå Withdrawal flow test error: ${error.message}`, 'withdrawal-log', true);
            }
        }
    </script>
</body>
</html>
